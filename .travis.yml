
# travis phases and our setup
# before_install
# install                           -- fetch/build non-haskell dependencies: savilerow, minion, lingeling
#                                   -- build conjure
#                                   -- save all these executables under $(pwd)/bin
# before_script
# script                            -- running tests
# after_success                     -- attempt cabal freeze
# after_failure
# OPTIONAL before_deploy
# OPTIONAL deploy
# OPTIONAL after_deploy
# after_script

language: c

sudo: false

matrix:
  include:
    - env: GHC_VERSION=7.8.4
      compiler: "# GHC 7.8.4" # apparently this forces travis to use separate caches for different compiler versions
                              # as seen in the Idris .travis.yml
                              # (until https://github.com/travis-ci/travis-ci/issues/4393 is resolved)
      addons:
        apt:
          packages:
            - g++-4.9
            - cabal-install-1.24
            - ghc-7.8.4
          sources:
            - hvr-ghc
            - ubuntu-toolchain-r-test
    - env: GHC_VERSION=7.10.3
      compiler: "# GHC 7.10.3"
      addons:
        apt:
          packages:
            - g++-4.9
            - cabal-install-1.24
            - ghc-7.10.3
          sources:
            - hvr-ghc
            - ubuntu-toolchain-r-test

before_install:
  - export CABALVER=1.24
  - export BIN_DIR=$(pwd)/bin
  - export PATH=${BIN_DIR}:/opt/ghc/${GHC_VERSION}/bin:/opt/cabal/${CABALVER}/bin:${HOME}/.cabal/bin:${PATH}

install:
  - mkdir -p bin

  # Savile Row
  - (savilerow | grep 'Savile Row 1.6.4') || etc/build/install-savilerow.sh
  - savilerow | head -n2 | tail -n1          # print version

  # Minion
  - (minion | grep 'Minion Version 2') || etc/build/install-minion.sh
  - minion help | head -n2                   # print version

  # Conjure
  - cabal --version || echo "cabal not found"
  - echo "$(ghc --version) [$(ghc --print-project-git-commit-id 2> /dev/null || echo '?')]"
  - travis_retry cabal update
  - if [ GHC_VERSION=7.8.4 ]; then rm cabal.config ; fi
  - echo ${PATH}
  - OPTIMISATION=-O1 BUILD_TESTS=yes CORES=2 make
  - conjure --version                        # print version

  - ls -l $(find bin -type f)

script:
  - time dist/build/conjure-testing/conjure-testing -p basic/set01 +RTS -s
  - cabal sdist   # tests that a source-distribution can be generated

after_success:
  - make freeze
  - git diff cabal.config

cache:
  directories:
    - ${HOME}/.cabal
    - ${HOME}/.ghc
    - .cabal-sandbox
    - dist
    - bin

