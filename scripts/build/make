#!/usr/bin/env ruby

require 'optparse'
require 'ostruct'

options = OpenStruct.new
options.jobs = 1                # nil means pass -j to cabal. otherwise -jNUMBER
options.profiling = false
options.tests = false
options.optimisation = false
options.documentation = false
options.llvm = false

OptionParser.new do |opts|
    opts.banner = "Usage: scripts/build/make [options]"

    opts.on("-j[OPTIONAL]", "--jobs[=OPTIONAL]", "Build in parallel.") do |v|
        options.jobs = Integer(v)
    end

    opts.on("-d", "--[no-]documentation", "Enable/disable building documentation.") do |v|
        options.documentation = v
    end

    opts.on("-p", "--[no-]profiling", "Build with profiling enabled.") do |v|
        options.profiling = v
    end

    opts.on("-t", "--[no-]tests", "Build and run tests too.") do |v|
        options.tests = v
    end

    opts.on("-O", "--[no-]optimisation", "Enable/disable optimisation.") do |v|
        options.optimisation = v
    end

    opts.on("-l", "--[no-]llvm", "Enable/disable llvm.") do |v|
        options.llvm = v
    end

end.parse!

paramsBuild = []
paramsBuild << "cabal" << "install" << "--force-reinstalls"

if options.jobs > 1
    paramsBuild << "-j#{options.jobs}"
elsif options.jobs == 0
    paramsBuild << "-j"
end

if options.documentation
    paramsBuild << "--enable-documentation"
else
    paramsBuild << "--disable-documentation"
end

if options.profiling
    paramsBuild << "--enable-library-profiling"
    paramsBuild << "--enable-executable-profiling"
else
    paramsBuild << "--disable-library-profiling"
    paramsBuild << "--disable-executable-profiling"
end

if options.optimisation
    paramsBuild << "-O2"
else
    paramsBuild << "-O0"
end

if options.llvm
    paramsBuild << '--ghc-options="-fllvm"'
end

system(*paramsBuild)

if options.tests
    paramsTestBuild = paramsBuild
    paramsTestBuild << "--enable-tests"
    system(*paramsTestBuild)

    paramsTestRun = []
    paramsTestRun << "cabal" << "test"
    system(*paramsTestRun)
end

